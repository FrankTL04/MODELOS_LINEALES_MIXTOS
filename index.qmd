---
title: "MODELOS LINEALES MIXTOS"
author: "FRANK TOMAPASCA"
format: html
---



# LIBRERIAS
```{r}
library(tidyverse)
library(googlesheets4)
library(lme4)
library(emmeans)
```




```{r}
library(googlesheets4)
library(tidyverse)

url <- "https://docs.google.com/spreadsheets/d/15r7ZwcZZHbEgltlF6gSFvCTFA-CFzVBWwg3mFlRyKPs/edit?gid=172957346#gid=172957346"

gs <- url %>%
  as_sheets_id()

fb <- gs %>%
  range_read(sheet = "fb")

view(fb)
```

```{r}
fb <- gs %>%
  range_read(sheet = "fb") %>%
  mutate(across(1:4, as.factor))  # Ejemplo: convierte columnas 1 a 4 en factores

str(fb)

```
```{r}
library(lme4)
```



# MODELO

$$ wue_(tuber) = \mu + bloque + riego +geno + riego*geno + e $$


# ANALISIS DE VARIANCIA

```{r}
md <- lmer(twue ~ 0 + riego * geno + (1 | bloque), data = fb)


anova(md)  # SIN SIGNIFICANCIA

library(car)

Anova(md)    # CON SIGNIFICANCIA
```
```{r}
library(lme4)
library(emmeans)
library(multcomp)
```

```{r}
# Medias ajustadas para la interacción riego:geno
emm <- emmeans(md, ~ riego:geno)

# Comparación de medias con ajuste de Tukey
comp <- pairs(emm, adjust = "tukey")

# Generación de letras de significancia
letras <- multcomp::cld(emm,
                        adjust = "tukey",   # método de ajuste
                        Letters = letters,  # función para asignar letras
                        alpha = 0.05,       # nivel de significancia
                        reversed = TRUE)    # opcional, orden de letras

# Mostrar las letras de significancia
letras

```


```{r}
library(multcompView)
library(ggplot2)
library(dplyr)

# Modelo mixto
md <- lmer(twue ~ 0 + (1|bloque) + riego*geno, data = fb)

# ANOVA tipo II o III según interés
library(car)
Anova(md, type = 3)
```
```{r}
# Medias ajustadas para la interacción riego:geno
emm <- emmeans(md, ~ riego:geno)

# Comparación de medias con ajuste de Tukey
comp <- pairs(emm, adjust = "tukey")

# Generación de letras de significancia
letras <- multcomp::cld(emm, adjust = "tukey", Letters = letters)
```


```{r}
letras

```

```{r}
# Limpieza del data frame con letras
letras_df <- letras %>%
  as.data.frame() %>%
  mutate(riego = factor(riego, levels = unique(fb$riego)),
         geno = factor(geno, levels = unique(fb$geno)))
```


```{r}
ggplot(letras_df, aes(x = geno, y = emmean, fill = riego)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE),
                width = 0.2, position = position_dodge(width = 0.8)) +
  geom_text(aes(label = .group, y = emmean + SE + 0.05),
            position = position_dodge(width = 0.8),
            size = 3, vjust = 0, angle = 90) +
  labs(x = "Genotipos", y = "TWUE (eficiencia del uso del agua total)",
       fill = "Riego") +
  theme_classic(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



























